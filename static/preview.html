<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Threshold Tuning</title>

    <!-- Deck.gl -->
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>

    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; font-family: sans-serif; }
        body { display: flex; flex-direction: column; background: #f0f0f0; }
        #map { flex: 2; position: relative; }
        .controls { 
            flex: 0 0 auto; 
            padding: 10px; 
            background: #fff; 
            display: flex; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { margin-bottom: 0; }
        .control-group input[type="range"] { width: 120px; }
        .control-group output { 
            font-weight: normal; 
            background-color: #e9ecef; 
            padding: 2px 6px; 
            border-radius: .25rem; 
            font-size: 0.9em; 
            min-width: 30px; 
            text-align: center;
        }
        .control-group .unit { font-size: 0.9em; }
        .changes { 
            flex: 1; 
            margin: 8px; 
            overflow: auto; 
            background: #272822; 
            color: #f8f8f2; 
            padding: 10px; 
            border-radius: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            font-family: monospace;
            white-space: pre;
        }
        button { 
            padding: 6px 12px; 
            background: #3e4989; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #31688e; }
        .legend { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: white; 
            padding: 10px; 
            border-radius: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            z-index: 1000; 
            display: flex; 
        }
        .legend-gradient { 
            height: 150px; 
            width: 20px; 
            background: linear-gradient(to bottom, #fde725, #b4de2c, #6dcd59, #35b779, #1f9e89, #26828e, #31688e, #3e4989, #482878, #440154); 
            border-radius: 2px; 
        }
        .legend-labels { 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            height: 150px; 
            margin-left: 8px; 
            font-size: 12px; 
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="control-group">
            <label>Min Threshold:</label>
            <input type="range" id="minSlider" step="1" />
            <output id="minOutput">0</output>
        </div>
        <div class="control-group">
            <label>Max Threshold:</label>
            <input type="range" id="maxSlider" step="1" />
            <output id="maxOutput">0</output>
        </div>
        <div class="control-group">
            <label>Resolution:</label>
            <input type="range" id="resolutionSlider" min="100" max="2000" step="50" value="500" />
            <output id="resolutionOutput">500</output>
            <span class="unit">px</span>
        </div>
        <div class="control-group">
            <label>DPI:</label>
            <input type="range" id="dpiSlider" min="50" max="600" step="10" value="100" />
            <output id="dpiOutput">100</output>
        </div>
        <div class="control-group">
            <label>Interpolation:</label>
            <select id="interpolationSelect">
                <option value="nearest">Nearest Neighbor</option>
                <option value="bilinear">Bilinear</option>
                <option value="bicubic">Bicubic</option>
                <option value="lanczos">Lanczos</option>
                <option value="gaussian">Gaussian</option>
            </select>
        </div>
        <div class="control-group">
            <label>Layer Opacity:</label>
            <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="0.75" />
            <output id="opacityOutput">0.75</output>
        </div>
        <button id="previewBtn">Preview</button>
    </div>
    
    <div id="map"></div>
    <div class="legend">
        <div class="legend-gradient"></div>
        <div class="legend-labels">
            <span id="maxLabel">100</span>
            <span id="minLabel">0</span>
        </div>
    </div>
    
    <div class="changes" id="changes"></div>

    <script>
        // OpenStreetMap tile layer configuration
        const OSM_TILE_LAYER = {
            id: 'osm-tiles',
            type: 'TileLayer',
            data: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
            tileSize: 256,
            minZoom: 0,
            maxZoom: 19,
            renderSubLayers: props => {
                const {
                    bbox: {west, south, east, north}
                } = props.tile;

                return new deck.BitmapLayer({
                    id: props.id,
                    data: null,
                    image: props.data,
                    bounds: [west, south, east, north]
                });
            }
        };

        // Initialize deck.gl
        let deckgl;
        let rasterLayer;
        let opacity = 0.75;

        // Get DOM elements
        const minSlider = document.getElementById('minSlider');
        const maxSlider = document.getElementById('maxSlider');
        const resolutionSlider = document.getElementById('resolutionSlider');
        const dpiSlider = document.getElementById('dpiSlider');
        const interpolationSelect = document.getElementById('interpolationSelect');
        const opacitySlider = document.getElementById('opacitySlider');
        const previewBtn = document.getElementById('previewBtn');

        const minOutput = document.getElementById('minOutput');
        const maxOutput = document.getElementById('maxOutput');
        const resolutionOutput = document.getElementById('resolutionOutput');
        const dpiOutput = document.getElementById('dpiOutput');
        const opacityOutput = document.getElementById('opacityOutput');
        const changesDiv = document.getElementById('changes');
        const minLabel = document.getElementById('minLabel');
        const maxLabel = document.getElementById('maxLabel');

        // Initialize the map
        function initializeMap() {
            deckgl = new deck.DeckGL({
                container: 'map',
                initialViewState: {
                    longitude: 0,
                    latitude: 0,
                    zoom: 2,
                    pitch: 0,
                    bearing: 0
                },
                controller: true,
                layers: [new deck.TileLayer(OSM_TILE_LAYER)]
            });
        }

        // Load initial value range
        function loadValueRange() {
            fetch('/value-range')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }

                    // Set slider ranges and values
                    minSlider.min = maxSlider.min = data.min;
                    minSlider.max = maxSlider.max = data.max;
                    minSlider.value = data.min;
                    maxSlider.value = data.max;
                    opacitySlider.value = data.defaultOpacity || 0.75;

                    // Update outputs
                    updateOutputs();
                })
                .catch(err => console.error('Error fetching value range:', err));
        }

        // Update all output values
        function updateOutputs() {
            minOutput.textContent = parseFloat(minSlider.value).toFixed(2);
            maxOutput.textContent = parseFloat(maxSlider.value).toFixed(2);
            resolutionOutput.textContent = resolutionSlider.value;
            dpiOutput.textContent = dpiSlider.value;
            opacityOutput.textContent = parseFloat(opacitySlider.value).toFixed(2);
            minLabel.textContent = parseFloat(minSlider.value).toFixed(2);
            maxLabel.textContent = parseFloat(maxSlider.value).toFixed(2);
        }

        // Handle preview button click
        function handlePreview() {
            const params = new URLSearchParams({
                min: minSlider.value,
                max: maxSlider.value,
                resolution: resolutionSlider.value,
                dpi: dpiSlider.value,
                interpolation: interpolationSelect.value
            });

            fetch(`/preview?${params}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Update raster layer
                    rasterLayer = new deck.BitmapLayer({
                        id: 'bitmap-layer',
                        bounds: [
                            data.bounds.west,
                            data.bounds.south,
                            data.bounds.east,
                            data.bounds.north
                        ],
                        image: data.imageUrl + '?t=' + Date.now(),
                        opacity: parseFloat(opacitySlider.value)
                    });

                    // Update view
                    const centerLon = (data.bounds.east + data.bounds.west) / 2;
                    const centerLat = (data.bounds.north + data.bounds.south) / 2;
                    
                    deckgl.setProps({
                        initialViewState: {
                            longitude: centerLon,
                            latitude: centerLat,
                            zoom: 5,
                            pitch: 0,
                            bearing: 0
                        },
                        layers: [new deck.TileLayer(OSM_TILE_LAYER), rasterLayer]
                    });

                    // Update changes display
                    changesDiv.textContent = JSON.stringify(data.rawChanges, null, 2);
                })
                .catch(err => {
                    console.error('Error fetching preview:', err);
                    alert('Error generating preview');
                });
        }

        // Add event listeners
        minSlider.addEventListener('input', updateOutputs);
        maxSlider.addEventListener('input', updateOutputs);
        resolutionSlider.addEventListener('input', updateOutputs);
        dpiSlider.addEventListener('input', updateOutputs);
        opacitySlider.addEventListener('input', function() {
            updateOutputs();
            if (rasterLayer) {
                rasterLayer = rasterLayer.clone({opacity: parseFloat(this.value)});
                deckgl.setProps({
                    layers: [new deck.TileLayer(OSM_TILE_LAYER), rasterLayer]
                });
            }
        });
        previewBtn.addEventListener('click', handlePreview);

        // Initialize the application
        initializeMap();
        loadValueRange();
    </script>
</body>
</html> 